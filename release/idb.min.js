(function(){var t,e,n,r,o,i,s,u,a,c,h,f,l,p,d,m,y=function(t,e){function n(){this.constructor=t}for(var r in e)b.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},b={}.hasOwnProperty,g=[].slice,w=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};if(h=window||self||global||this,"undefined"!=typeof h.Promise)p=function(){var t;return t={},t.promise=new Promise(function(e,n){return t.resolve=e,t.reject=n}),t},m=function(t){return t.promise};else if("undefined"!=typeof h.Q)p=function(){return Q.defer()},m=function(t){return t.promise};else{if("undefined"==typeof h.jQuery)throw new n("Not compatible promise function found.");p=function(){return jQuery.Deferred()},m=function(t){return t.promise({"catch":function(t){return this.fail(t)}})}}if(d=function(t,e){var n;if(n=p(),t)n.resolve(t);else{if(!e)throw new Error("either result or error must provided to newPromise().");n.reject(e)}return m(n)},f=h.indexedDB||h.mozIndexedDB||h.webkitIndexedDB||h.msIndexedDB,i=h.IDBTransaction||h.webkitIDBTransaction||h.msIDBTransaction,r=h.IDBKeyRange||h.webkitIDBKeyRange||h.msIDBKeyRange,o=function(t){var e;return e=p(),t.onsuccess=function(t){return e.resolve(t)},t.onerror=t.onblocked=function(t){return e.reject(t)},m(e)},s=function(t){var e;return e=p(),t.onComplete=function(t){return e.resolve(t)},t.onerror=t.onabort=function(t){return e.reject(t)},m(e)},n=function(t){function e(t){this.message=t,console.error("IDBError: "+this.message)}return y(e,t),e}(Error),a=function(){function t(t){this.stores={},this.applyDefinition(t)}var e;return t.Store=function(){function t(t){this.name=t,this.option={keyPath:null,autoIncrement:null},this.indexes={}}return t.prototype.addIndex=function(t,e,r,o){if(this.indexes.hasOwnProperty(t))throw new n("index("+t+") duplicated at ObjectStore("+this.name+").");this.indexes[t]={name:t,key:e,option:{unique:r,multiEntry:o}}},t}(),t.prototype.applyDefinition=function(t){var r,o,i,s,u,a,c,h,f,l,p,d;if("object"!=typeof t)throw new n("The database definition must be JSON.");f=[];for(d in t){if(p=t[d],"string"!=typeof d)throw new n("Store name must be string.");if(!("object"==typeof p&&p instanceof Array))throw new n("The definition of store("+d+") must be in array.");for(l=new this.constructor.Store(d),o=0,c=p.length;c>o;o++){if(r=p[o],"string"!=typeof r)throw new n("Index definition must be in string form.");if(r=r.trim().replace(/[\s\t]+/g," ").replace(/\s?\(\s?/g,"(").replace(/\s?\)\s?/g,")").replace(/\s?\.\s?/g,"."),r.match(/^KEY/)){if(null!=l.option.keyPath)throw new n("Store key duplicated.");(h=r.match(/^KEY(\(.+\)).*$/))&&(l.option.keyPath=e(h[1])),r.match(/AUTO$/)&&(l.option.autoIncrement=!0)}else{if(i=r.replace(/[\(\s].+/,""),!i.match(/(\w|\.)+/))throw new n("Invalid index name("+i+").");u=r.match(/[\s\)]UNIQUE/g)?!0:!1,s=r.match(/[\s\)]ARRAY/g)?!0:!1,a=(h=r.match(/.+(\(.+\)).*/))?e(h[1]):i,l.addIndex(i,a,u,s)}}f.push(this.stores[d]=l)}return f},e=function(t){var n,r,o,i;return(i=t.indexOf("("))>-1?(t=t.slice(i+1,t.lastIndexOf(")")),(r=t.match(/[^,]+/g))?(n=function(){var t,n,i;for(i=[],t=0,n=r.length;n>t;t++)o=r[t],i.push(e(o.trim()));return i}(),(n.length=1)?n[0]:n):t):t},t}(),u=function(){function t(t,e,n){this._store=t,this._indexName=e,this._range=n,this._limitTo=null,this._limitFrom=0,this._order="next"}return t.prototype.getIDBIndexIfSet=function(t){var e;try{return this._indexName?t.index(this._indexName):t}catch(n){return e=n,t}},t.prototype.order=function(t){return this._order=-1===t||"string"==typeof t&&t.match(/desc/i)?"prev":"next",this},t.prototype.limit=function(){var t,e,r,o;return t=1<=arguments.length?g.call(arguments,0):[],o=function(){switch(t.length){case 1:if(r=t[0],"number"!=typeof r||1>r)throw new n("length must be > 0 for Query.limit()");return[0,r-1];case 2:if(e=t[0],r=t[1],"number"!=typeof e||0>e)throw new n("starting position must be > -1 for Query.limit()");if("number"!=typeof r||1>r)throw new n("length must be > 0 for Query.limit()");return[e,e+r-1];default:throw new n("wrong usage of Query.limit()")}}(),this._limitFrom=o[0],this._limitTo=o[1],this},t.prototype.each=function(t){return this._store.getIDBObjectStore("readonly").then(function(e){return function(n){var r,o,i;return o=p(),r=0,i=[],e.getIDBIndexIfSet(n).openCursor(e._range,e._order).onsuccess=function(n){var s,u,a;if(!(s=n.target.result))return o.resolve(i);if(r<e._limitFrom)return s.advance(r=e._limitFrom);if(null!==e._limitTo&&r>e._limitTo)return o.resolve(i);try{return a=t(s.value,s.key),void 0!==a&&i.push(a),r++,s["continue"]()}catch(c){return u=c,o.reject(u)}},m(o)}}(this))},t.prototype.first=function(t){return this.limit(1).each(function(t,e){return[t,e]}).then(function(e){return e.length>0?t(e[0][0],e[0][1]):t(null,null)})},t.prototype.list=function(t){var e,n;return n=[],e=[],this.each(function(t,r){return n.push(t),e.push(r)}).then(function(){return t(n,e)})},t.prototype.count=function(t){return this._store.getIDBObjectStore("readonly").then(function(t){return function(e){return o(t.getIDBIndexIfSet(e).count(t._range))}}(this)).then(function(e){return t(e.target.result)})},t}(),c=function(){function t(t,e){this._name=t,this._db=e}var e;return t.prototype.getIDBObjectStore=function(t){return null==t&&(t="readwrite"),this._db.getIDBTransaction(this._name,t).then(function(t){return function(e){return e.objectStore(t._name)}}(this))},t.prototype.key=function(){return this.getIDBObjectStore("readonly").then(function(t){return t.keyPath})},t.prototype.name=function(){return this.getIDBObjectStore("readonly").then(function(t){return t.name})},t.prototype.indexes=function(){return this.getIDBObjectStore("readonly").then(function(t){return t.indexNames})},t.prototype.isAutoKey=function(){return this.getIDBObjectStore("readonly").then(function(t){return t.autoIncrement})},t.prototype.add=function(){var t;return t=1<=arguments.length?g.call(arguments,0):[],this.getIDBObjectStore().then(function(e){return o(e.add.apply(e,t))})},t.prototype.update=function(){var t;return t=1<=arguments.length?g.call(arguments,0):[],this.getIDBObjectStore().then(function(e){return o(e.put.apply(e,t))})},t.prototype["delete"]=function(t){return this.getIDBObjectStore().then(function(e){return o(e["delete"](t))})},t.prototype.clear=function(){return this.getIDBObjectStore().then(function(t){return o(t.clear())})},t.prototype.where=function(t){var o,i,s,a;return"string"==typeof t&&(t=t.trim()),a=function(){switch(!1){case!(null===t||""===t):return[null,null];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*<=[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*<=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(i[2]),r.bound(e(i[1]),e(i[3]))];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*<[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*<=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(i[2]),r.bound(e(i[1]),e(i[3]),!0)];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*<=[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*<[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(i[2]),r.bound(e(i[1]),e(i[3]),!1,!0)];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*<[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*<[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(i[2]),r.bound(e(i[1]),e(i[3]),!0,!0)];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*>=[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*>=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(i[2]),r.bound(e(i[3]),e(i[1]))];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*>[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*>=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(i[2]),r.bound(e(i[3]),e(i[1]),!0)];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*>=[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*>[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(i[2]),r.bound(e(i[3]),e(i[1]),!1,!0)];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*>[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*>[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(i[2]),r.bound(e(i[3]),e(i[1]),!0,!0)];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*<=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(i[1]),r.upperBound(e(i[2]))];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*<[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(i[1]),r.upperBound(e(i[2]),!0)];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*>=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(i[1]),r.lowerBound(e(i[2]))];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*>[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(i[1]),r.lowerBound(e(i[2]),!0)];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*=[\s\t]*('.*'|".*"|\[.*\]|[^\s\t]+)$/)):return[e(i[1]),r.only(e(i[2]))];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)$/)):return[e(i[1]),null];default:throw new n("Unknown statment ("+t+").")}}(),o=a[0],s=a[1],new u(this,o,s)},t.prototype.all=function(){return this.where(null)},e=function(t){var n,r,o,i,s;if(t.match(/^\[.*\]$/)){for(o=t.slice(1,-1).match(/(\[.+\]|'.*'|".*"|[^,]+)/g),i=[],n=0,r=o.length;r>n;n++)s=o[n],i.push(e(s.trim()));return i}return isNaN(t)?t.match(/^('.*'|".*")$/)?t.slice(1,-1):t:+t},t}(),t=function(){function t(t){this._name=t,this._version=null,this._dbDefinition=null,this._onVersionConflictHandler=null,this._idbDatabase=null,this._batchTx=null}return t.prototype.name=function(){return this.getIDBDatabase().then(function(t){return t.name})},t.prototype.version=function(t,e){return t?null===this._version||this._version<=t?(this._dbDefinition=e,this._version=t,this):void 0:this.getIDBDatabase().then(function(t){return t.version})},t.prototype.onVersionConflict=function(t){return this._onVersionConflictHandler=t},t.prototype.getIDBDatabase=function(){var t;return null!=this._idbDatabase?d(this._idbDatabase):(console.log("open db "+this._name+" "+this._version),t=f.open(this._name,this._version),t.onblocked=this._onVersionConflictHandler,t.onupgradeneeded=function(t){return function(e){return t.doUpgrade(e.target.result)}}(this),o(t).then(function(t){return function(e){return t._idbDatabase=e.target.result}}(this)))},t.prototype.getIDBTransaction=function(t,e){return this._batchTx?d(this._batchTx):this.getIDBDatabase().then(function(n){return n.transaction(t,e)})},t.prototype.store=function(t){return new c(t,this)},t.prototype.close=function(){this._idbDatabase&&(this._idbDatabase.close(),this._idbDatabase=null)},t.prototype.remove=function(){return this.close(),o(f.deleteDatabase(this._name)).then(function(t){return function(){return t._name=t._version=t._dbDefinition=t._onVersionConflictHandler=t._idbDatabase=t._batchTx=null}}(this))["catch"](function(t){if(!t instanceof IDBVersionChangeEvent)throw t})},t.prototype.batch=function(){var t,e;return e=1<=arguments.length?g.call(arguments,0):[],this._batchTx=null,t=this.getIDBTransaction(e,"readwrite").then(function(t){return function(e){return t._batchTx=e}}(this)),{run:function(e){return function(n){return t.then(function(){try{return n(e)}finally{e._batchTx=null}})}}(this)}},t.prototype.doUpgrade=function(t){var e,r,o,i,s,u,c,h,f,l,p,d,m,y,b,g,_,D,I;if(null===this._dbDefinition)throw new n("DB definition not found.");if(console.log("upgrade db "+this._name+" "+this._version),e=new a(this._dbDefinition),console.log(e),o=[],i=t.objectStoreNames,i.length>0)for(I=t.transaction(i,"readwrite"),s=function(r){var i,s,u,a,c,h,f;if(e.stores.hasOwnProperty(r)){for(h=I.objectStore(r),i=h.indexNames,f=e.stores[r],c=[],u=0,a=i.length;a>u;u++)s=i[u],c.push(function(t){var e,r;if(!f.indexes.hasOwnProperty(t))return o.push(function(){return h.deleteIndex(t)});if(e=h.index(t),r=f.indexes[t],!e.unique&&r.option.unique)throw new n("Turning existed index("+t+") to be unique is not allowed.");return e.keyPath!==r.key||e.unique!==r.option.unique||e.multiEntry!==r.option.multiEntry?(o.push(function(){return h.deleteIndex(t)}),o.push(function(){return h.createIndex(t,r.key,r.option)})):void 0}(s));return c}return o.push(function(){return t.deleteObjectStore(r)})},c=0,p=i.length;p>c;c++)_=i[c],s(_);m=e.stores;for(_ in m)if(D=m[_],w.call(i,_)<0){g=t.createObjectStore(_,D.option),y=D.indexes,u=function(t,e,n){return o.push(function(){return t.createIndex(e,n.key,n.option)})};for(h in y)f=y[h],u(g,h,f)}for(b=[],l=0,d=o.length;d>l;l++)r=o[l],b.push(r());return b},t}(),e=function(){var e,r;return r={},e=function(e){return r.hasOwnProperty(e)||(r[e]=new t(e)),r[e]},e.Error=n,e}(),"function"==typeof define&&null!=define.amd)define("IDB",e);else if(null!=("undefined"!=typeof module&&null!==module?module.exports:void 0))module.exports=e;else if(this.hasOwnProperty("IDB"))if(this.hasOwnProperty("$IDB")){if(l="Fail to export IDB: name 'IDB' and '$IDB' is in use.","function"!=typeof("undefined"!=typeof console&&null!==console?console.error:void 0))throw l;console.error(l)}else this.$IDB=e;else this.IDB=e}).call(this);