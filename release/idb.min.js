(function(){var e,t,n,r,o,i,u,a,c,s,f,l,p,h,d,y=function(e,t){function n(){this.constructor=e}for(var r in t)m.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},m={}.hasOwnProperty,g=[].slice,b=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};if(f=window||self||global||this,"undefined"!=typeof f.Promise)h=function(){var e;return e={},e.promise=new Promise(function(t,n){return e.resolve=t,e.reject=n}),e},d=function(e){return e.promise};else if("undefined"!=typeof f.Q)h=function(){return Q.defer()},d=function(e){return e.promise};else{if("undefined"==typeof f.jQuery)throw new n("Not compatible promise function found.");h=function(){return jQuery.Deferred()},d=function(e){return e.promise({"catch":function(e){return this.fail(e)}})}}if(l=f.indexedDB||f.mozIndexedDB||f.webkitIndexedDB||f.msIndexedDB,i=f.IDBTransaction||f.webkitIDBTransaction||f.msIDBTransaction,r=f.IDBKeyRange||f.webkitIDBKeyRange||f.msIDBKeyRange,o=function(e){var t;return t=h(),e.onsuccess=function(e){return t.resolve(e)},e.onerror=function(e){return t.reject(e)},d(t)},u=function(e){var t;return t=h(),e.onComplete=function(e){return t.resolve(e)},e.onerror=e.onabort=function(e){return t.reject(e)},d(t)},n=function(e){function t(e){this.message=e,console.error("IDBError: "+this.message)}return y(t,e),t}(Error),c=function(){function e(e){var o,i,u,a,c,s,f,l,p,h;if("object"!=typeof e)throw new n("The database definition must be JSON.");for(h in e){if(p=e[h],"string"!=typeof h)throw new n("Store name must be string.");if(!("object"==typeof p&&p instanceof Array))throw new n("The definition of store("+h+") must be in array.");for(l=new this.constructor.Store(h),i=0,f=p.length;f>i;i++){if(o=p[i],"string"!=typeof o)throw new n("Index definition must be in string form.");if(o=o.trim().replace(/(\s|\t)+/g," ").replace(/\s?\(\s?/g,"(").replace(/\s?\)\s?/g,")").replace(/\s?,\s?/g,",").replace(/\s?\+\s?/g,"+").replace(/\s?\.\s?/g,"."),o.match(/^KEY/)){if(null!=l.option.keyPath)throw new n("Store key duplicated.");o.match(/^KEY\(.+\)/)&&(l.option.keyPath=r(o.slice(4,o.indexOf(")")))),o.match(/AUTO$/)&&(l.option.autoIncrement=!0)}else{if(u=o.replace(/\(.+\)/,"").replace(/( UNIQUE)$/,""),!u.match(/(\w|\.)+/))throw new n("Invalid index name("+u+").");c=o.match(/( UNIQUE)$/)?!0:!1,a=!1,s=function(){if(o.match(/^.+\(.+\)/)){if(o.indexOf(",")>-1&&(a=!0),a&&o.indexOf("+")>-1)throw new n("Fail to parse definition("+string+"): ',' and '+' cannot state in the same definition.");return r(o.slice(o.indexOf("(")+1,o.indexOf(")")))}return t(u)}(),l.addIndex(u,s,c,a)}}this.stores[h]=l}}var t,r;return e.prototype.stores={},e.Store=function(){function e(e){this.name=e,this.option={keyPath:null,autoIncrement:null},this.indexes={}}return e.prototype.addIndex=function(e,t,r,o){if(this.indexes.hasOwnProperty(e))throw new n("index("+e+") duplicated at ObjectStore("+this.name+").");this.indexes[e]={name:e,key:t,option:{unique:r,multiEntry:o}}},e}(),r=function(e){var t,o,i,u,a,c,s,f,l;if(e.indexOf(",")>-1){for(c=e.split(","),f=[],t=0,u=c.length;u>t;t++)i=c[t],f.push(r(i));return f}if(e.indexOf("+")>-1){for(s=e.split("+"),l=[],o=0,a=s.length;a>o;o++)i=s[o],l.push(r(i));return l}if(e.indexOf(".")>-1&&(e=e.replace(".",",")),e.match(/^(\'\'|\"\")$/))return"";if(e.match(/(\'|\")/g))throw new n("Fail to parse definition("+e+"): quotation mark not in pairs.");return e},t=function(e){return e.indexOf(".")>-1?e.split("."):e},e}(),a=function(){function e(e,n,o){i=e,t=null!=n?n:e.key(),r=o}var t,n,r,i;return i=t=r=n=null,e.prototype.order=function(e){return n=-1===e||"string"==typeof e&&e.match(/desc/)?"prev":null,this},e.prototype.each=function(e){var r,o,u;return r=h(),o=i.getIDBObjectStore("readonly").index(t),u=o.openCursor(range,n),u.onsuccess=function(t){var n,o;if(!(n=t.target.result))return r.resolve(t);try{return e(n.key,n.value,t)===!1?r.resolve(t):n["continue"]()}catch(i){return o=i,r.reject(o)}},u.onerror=function(e){return r.reject(e)},d(r)},e.prototype.first=function(e){var n;return n=i.getIDBObjectStore("readonly").index(t),o(n.get(range)).then(function(t){return e(t.target.result)})},e.prototype.list=function(e){var t;return t=[],this.each(function(e){return t.push(e)}).then(e(t))},e.prototype.count=function(e){var n;return n=i.getIDBObjectStore("readonly").index(t),o(n.count(r)).then(function(t){return e(t.target.result)})},e}(),s=function(){function e(e,n){i=e,t=n}var t,i,u;return i=t=null,e.prototype.getIDBObjectStore=function(e){return null==e&&(e="readwrite"),t.getIDBTransaction(i,e).then(function(e){return e.objectStore(i)})},e.prototype.key=function(){return this.getIDBObjectStore("readonly").then(function(e){return e.keyPath})},e.prototype.name=function(){return this.getIDBObjectStore("readonly").then(function(e){return e.name})},e.prototype.indexes=function(){return this.getIDBObjectStore("readonly").then(function(e){return e.indexNames})},e.prototype.isAutoIncrement=function(){return this.getIDBObjectStore("readonly").then(function(e){return e.autoIncrement})},e.prototype.add=function(){var e;return e=1<=arguments.length?g.call(arguments,0):[],this.getIDBObjectStore().then(function(t){return o(t.add.apply(t,e))})},e.prototype.update=function(){var e;return e=1<=arguments.length?g.call(arguments,0):[],this.getIDBObjectStore().then(function(t){return o(t.put.apply(t,e))})},e.prototype["delete"]=function(e){return this.getIDBObjectStore().then(function(t){return o(t["delete"](e))})},e.prototype.clear=function(){return this.getIDBObjectStore().then(function(e){return o(e.clear())})},e.prototype.where=function(e){var t,o,i,c,s,f,l,p,h,d,y,m,g,b,w,I,v,x;switch(t=e.trim().replace(/(\s|\t)+/g,""),!1){case!t.match(/^.+=.+$/):s=t.split("="),o=s[0],c=s[1],c=r.only(u(c));break;case!t.match(/^.+<.+$/):f=t.split("<"),o=f[0],c=f[1],c=r.upperBound(u(c,!0));break;case!t.match(/^.+<=.+$/):d=t.split("<="),o=d[0],c=d[1],c=r.upperBound(u(c));break;case!t.match(/^.+>.+$/):y=t.split(">"),o=y[0],c=y[1],c=r.lowerBound(u(c,!0));break;case!t.match(/^.+>=.+$/):m=t.split(">="),o=m[0],c=m[1],c=r.lowerBound(u(c));break;case!t.match(/^.+<.+<.+$/):g=t.split("<"),i=g[0],o=g[1],x=g[2],c=r.bound(u(i,u(x,!0,!0)));break;case!t.match(/^.+<=.+<.+$/):b=t.split(/<\=?/),i=b[0],o=b[1],x=b[2],c=r.bound(u(i,u(x,!1,!0)));break;case!t.match(/^.+<.+<=.+$/):w=t.split("<=?"),i=w[0],o=w[1],x=w[2],c=r.bound(u(i,u(x,!0)));break;case!t.match(/^.+<=.+<=.+$/):I=t.split("<="),i=I[0],o=I[1],x=I[2],c=r.bound(u(i,u(x)));break;case!t.match(/^.+>.+>.+$/):v=t.split(">"),x=v[0],o=v[1],i=v[2],c=r.bound(u(i,u(x,!0,!0)));break;case!t.match(/^.+>=.+>.+$/):l=t.split(/>\=?/),x=l[0],o=l[1],i=l[2],c=r.bound(u(i,u(x,!1,!0)));break;case!t.match(/^.+>.+>=.+$/):p=t.split(">=?"),x=p[0],o=p[1],i=p[2],c=r.bound(u(i,u(x,!0)));break;case!t.match(/^.+>=.+>=.+$/):h=t.split(">="),x=h[0],o=h[1],i=h[2],c=r.bound(u(i,u(x)));break;default:throw new n("Unknown statment ("+e+").")}return new a(this,o,c)},u=function(e){var t,n,r,o,i;if(e.match(/^\[.*\]$/)){for(r=e.slice(1,-1).match(/(\[.+\]|'.+'|".+"|[^,]+)/g),o=[],t=0,n=r.length;n>t;t++)i=r[t],o.push(u(i));return o}return isNaN(e)?e.match(/^('|").+('|")$/)?e.slice(1,-1):e:+e},e}(),e=function(){function e(e){i=e}var t,r,i,a,f,p,y;return i=p=f=a=r=t=null,e.prototype.name=function(){return i},e.prototype.version=function(e,t){return e?null===p||e>=p?(f=new c(t),p=e):void 0:p},e.prototype.onVersionConflict=function(e){return a=e},e.prototype.getIDBDatabase=function(){var e,t;return null!=r?(e=h(),e.resolve(r),d(e)):(t=l.open(i,p),t.onblocked=a,t.onupgradeneeded=function(e){return y(e.target.result)},o(t).then(function(e){return r=e.target.result}))},e.prototype.getIDBTransaction=function(e,n){var r;return t?(r=h(),r.resolve(t),d(r)):this.getIDBDatabase().then(function(t){return t.transaction(e,n)})},e.prototype.store=function(e){return new s(e,this)},e.prototype.remove=function(){return o(indexDB.deleteDatabase(i)).then(function(){return i=p=f=a=r=t=null})},e.prototype.batch=function(){var e,n;return n=1<=arguments.length?g.call(arguments,0):[],t=null,e=null,this.getIDBTransaction(n,"readonly").then(function(n){return t=n,null!==e?e():void 0}),{run:function(n){return function(r){return e=function(){try{return r(n)}finally{e=null,t=null}},null!==t&&e(),u(t)}}(this)}},y=function(e){var t,r,o,i,u,a,c,s,l,p,h,d,y,m,g,w,I,v;if(null===f)throw new n("Schema not found.");if(r=[],o=e.objectStoreNames,o.length>0)for(v=e.transaction(o,"readwrite"),i=function(t){var o,i,u,a,c,s,l;if(f.stores.hasOwnProperty(t)){for(s=v.objectStore(t),o=s.indexNames,l=f.stores[t],c=[],u=0,a=o.length;a>u;u++)i=o[u],c.push(function(e){var t,o;if(!l.indexes.hasOwnProperty(e))return r.push(function(){return s.deleteIndex(e)});if(t=s.index(e),o=l.indexes[e],!t.unique&&o.option.unique)throw new n("Turning existed index("+e+") to be unique is not allowed.");return t.keyPath!==o.key||t.unique!==o.option.unique||t.multiEntry!==o.option.multiEntry?(r.push(function(){return s.deleteIndex(e)}),r.push(function(){return s.createIndex(e,o.key,o.option)})):void 0}(i));return c}return r.push(function(){return e.deleteObjectStore(t)})},a=0,p=o.length;p>a;a++)w=o[a],i(w);d=f.stores;for(w in d)if(I=d[w],b.call(o,w)<0){g=e.createObjectStore(w,I.option),y=I.indexes,u=function(e,t,n){return r.push(function(){return e.createIndex(t,n.key,n.option)})};for(c in y)s=y[c],u(g,c,s)}for(m=[],l=0,h=r.length;h>l;l++)t=r[l],m.push(t());return m},e}(),t=function(){var t,r;return r={},t=function(t){return r.hasOwnProperty(t)||(r[t]=new e(t)),r[t]},t.Error=n,t}(),"function"==typeof define&&null!=define.amd)define("IDB",t);else if(null!=("undefined"!=typeof module&&null!==module?module.exports:void 0))module.exports=t;else if(this.hasOwnProperty("IDB"))if(this.hasOwnProperty("$IDB")){if(p="Fail to export IDB: name 'IDB' and '$IDB' is in use.","function"!=typeof("undefined"!=typeof console&&null!==console?console.error:void 0))throw p;console.error(p)}else this.$IDB=t;else this.IDB=t}).call(this);