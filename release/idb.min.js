(function(){var t,e,n,r,o,u,i,s,c,a,f,l,h,p,d,y,m=function(t,e){function n(){this.constructor=t}for(var r in e)g.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},g={}.hasOwnProperty,w=[].slice,I=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};if(f=window||self||global||this,"undefined"!=typeof f.Promise)p=function(){var t;return t={},t.promise=new Promise(function(e,n){return t.resolve=e,t.reject=n}),t},y=function(t){return t.promise};else if("undefined"!=typeof f.Q)p=function(){return Q.defer()},y=function(t){return t.promise};else{if("undefined"==typeof f.jQuery)throw new n("Not compatible promise function found.");p=function(){return jQuery.Deferred()},y=function(t){return t.promise({"catch":function(t){return this.fail(t)}})}}if(d=function(t,e){var n;if(n=p(),t)n.resolve(t);else{if(!e)throw new Error("either result or error must provided to newPromise().");n.reject(e)}return y(n)},l=f.indexedDB||f.mozIndexedDB||f.webkitIndexedDB||f.msIndexedDB,u=f.IDBTransaction||f.webkitIDBTransaction||f.msIDBTransaction,r=f.IDBKeyRange||f.webkitIDBKeyRange||f.msIDBKeyRange,o=function(t){var e;return e=p(),t.onsuccess=function(t){return e.resolve(t)},t.onerror=function(t){return e.reject(t)},y(e)},i=function(t){var e;return e=p(),t.onComplete=function(t){return e.resolve(t)},t.onerror=t.onabort=function(t){return e.reject(t)},y(e)},n=function(t){function e(t){this.message=t,console.error("IDBError: "+this.message)}return m(e,t),e}(Error),c=function(){function t(t){var o,u,i,s,c,a,f,l,h,p;if("object"!=typeof t)throw new n("The database definition must be JSON.");for(p in t){if(h=t[p],"string"!=typeof p)throw new n("Store name must be string.");if(!("object"==typeof h&&h instanceof Array))throw new n("The definition of store("+p+") must be in array.");for(l=new this.constructor.Store(p),u=0,f=h.length;f>u;u++){if(o=h[u],"string"!=typeof o)throw new n("Index definition must be in string form.");if(o=o.trim().replace(/(\s|\t)+/g," ").replace(/\s?\(\s?/g,"(").replace(/\s?\)\s?/g,")").replace(/\s?,\s?/g,",").replace(/\s?\+\s?/g,"+").replace(/\s?\.\s?/g,"."),o.match(/^KEY/)){if(null!=l.option.keyPath)throw new n("Store key duplicated.");o.match(/^KEY\(.+\)/)&&(l.option.keyPath=r(o.slice(4,o.indexOf(")")))),o.match(/AUTO$/)&&(l.option.autoIncrement=!0)}else{if(i=o.replace(/\(.+\)/,"").replace(/( UNIQUE)$/,""),!i.match(/(\w|\.)+/))throw new n("Invalid index name("+i+").");c=o.match(/( UNIQUE)$/)?!0:!1,s=!1,a=function(){if(o.match(/^.+\(.+\)/)){if(o.indexOf(",")>-1&&(s=!0),s&&o.indexOf("+")>-1)throw new n("Fail to parse definition("+string+"): ',' and '+' cannot state in the same definition.");return r(o.slice(o.indexOf("(")+1,o.indexOf(")")))}return e(i)}(),l.addIndex(i,a,c,s)}}this.stores[p]=l}}var e,r;return t.prototype.stores={},t.Store=function(){function t(t){this.name=t,this.option={keyPath:null,autoIncrement:null},this.indexes={}}return t.prototype.addIndex=function(t,e,r,o){if(this.indexes.hasOwnProperty(t))throw new n("index("+t+") duplicated at ObjectStore("+this.name+").");this.indexes[t]={name:t,key:e,option:{unique:r,multiEntry:o}}},t}(),r=function(t){var e,o,u,i,s,c,a,f,l;if(t.indexOf(",")>-1){for(c=t.split(","),f=[],e=0,i=c.length;i>e;e++)u=c[e],f.push(r(u));return f}if(t.indexOf("+")>-1){for(a=t.split("+"),l=[],o=0,s=a.length;s>o;o++)u=a[o],l.push(r(u));return l}if(t.indexOf(".")>-1&&(t=t.replace(".",",")),t.match(/^(\'\'|\"\")$/))return"";if(t.match(/(\'|\")/g))throw new n("Fail to parse definition("+t+"): quotation mark not in pairs.");return t},e=function(t){return t.indexOf(".")>-1?t.split("."):t},t}(),s=function(){function t(t,n,o){u=t,e=n,r=o}var e,n,r,u,i;return u=e=r=null,n="next",t.prototype.order=function(t){return n=-1===t||"string"==typeof t&&t.match(/desc/)?"prev":"next",this},t.prototype.each=function(t){return u.getIDBObjectStore("readonly").then(function(e){var o,u;return u=p(),o=i(e).openCursor(r,n),o.onsuccess=function(e){var n,r;if(!(n=e.target.result))return u.resolve();try{return t(n.value,n.key),n["continue"]()}catch(o){return r=o,u.reject(r)}},y(u)})},t.prototype.first=function(t){return u.getIDBObjectStore("readonly").then(function(t){return o(i(t).get(r))}).then(function(e){return t(e.target.result)})},t.prototype.list=function(t){var e,n;return n=[],e=[],this.each(function(t,r){return n.push(t),e.push(r)}).then(function(){return t(n,e)})},t.prototype.count=function(t){return u.getIDBObjectStore("readonly").then(function(t){return o(i(t).count(r))}).then(function(e){return t(e.target.result)})},i=function(t){return e?t.index(e):t},t}(),a=function(){function t(t,n){u=t,e=n}var e,u,i;return u=e=null,t.prototype.getIDBObjectStore=function(t){return null==t&&(t="readwrite"),e.getIDBTransaction(u,t).then(function(t){return t.objectStore(u)})},t.prototype.key=function(){return this.getIDBObjectStore("readonly").then(function(t){return t.keyPath})},t.prototype.name=function(){return this.getIDBObjectStore("readonly").then(function(t){return t.name})},t.prototype.indexes=function(){return this.getIDBObjectStore("readonly").then(function(t){return t.indexNames})},t.prototype.isAutoKey=function(){return this.getIDBObjectStore("readonly").then(function(t){return t.autoIncrement})},t.prototype.add=function(){var t;return t=1<=arguments.length?w.call(arguments,0):[],this.getIDBObjectStore().then(function(e){return o(e.add.apply(e,t))})},t.prototype.update=function(){var t;return t=1<=arguments.length?w.call(arguments,0):[],this.getIDBObjectStore().then(function(e){return o(e.put.apply(e,t))})},t.prototype["delete"]=function(t){return this.getIDBObjectStore().then(function(e){return o(e["delete"](t))})},t.prototype.clear=function(){return this.getIDBObjectStore().then(function(t){return o(t.clear())})},t.prototype.where=function(t){var e,o,u,c;return"string"==typeof t&&(t=t.trim()),c=function(){switch(!1){case!(null===t||""===t):return[null,null];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*<=[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*<=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[i(o[2]),r.bound(i(o[1]),i(o[3]))];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*<[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*<=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[i(o[2]),r.bound(i(o[1]),i(o[3]),!0)];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*<=[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*<[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[i(o[2]),r.bound(i(o[1]),i(o[3]),!1,!0)];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*<[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*<[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[i(o[2]),r.bound(i(o[1]),i(o[3]),!0,!0)];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*>=[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*>=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[i(o[2]),r.bound(i(o[3]),i(o[1]))];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*>[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*>=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[i(o[2]),r.bound(i(o[3]),i(o[1]),!0)];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*>=[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*>[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[i(o[2]),r.bound(i(o[3]),i(o[1]),!1,!0)];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*>[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*>[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[i(o[2]),r.bound(i(o[3]),i(o[1]),!0,!0)];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*<=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[i(o[1]),r.upperBound(i(o[2]))];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*<[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[i(o[1]),r.upperBound(i(o[2]),!0)];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*>=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[i(o[1]),r.lowerBound(i(o[2]))];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*>[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[i(o[1]),r.lowerBound(i(o[2]),!0)];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[i(o[1]),r.only(i(o[2]))];default:throw new n("Unknown statment ("+t+").")}}(),e=c[0],u=c[1],new s(this,e,u)},t.prototype.all=function(){return this.where(null)},i=function(t){var e,n,r,o,u;if(t.match(/^\[.*\]$/)){for(r=t.slice(1,-1).match(/(\[.+\]|'.*'|".*"|[^,]+)/g),o=[],e=0,n=r.length;n>e;e++)u=r[e],o.push(i(u.trim()));return o}return isNaN(t)?t.match(/^('.*'|".*")$/)?t.slice(1,-1):t:+t},t}(),t=function(){function t(t){u=t}var e,r,u,s,f,h,p;return u=h=f=s=r=e=null,t.prototype.name=function(){return this.getIDBDatabase().then(function(t){return t.name})},t.prototype.version=function(t,e){return t?null===h||t>=h?(f=new c(e),h=t):void 0:this.getIDBDatabase().then(function(t){return t.version})},t.prototype.onVersionConflict=function(t){return s=t},t.prototype.getIDBDatabase=function(){var t;return null!=r?d(r):(t=l.open(u,h),t.onblocked=s,t.onupgradeneeded=function(t){return p(t.target.result)},o(t).then(function(t){return r=t.target.result}))},t.prototype.getIDBTransaction=function(t,n){return e?d(e):this.getIDBDatabase().then(function(e){return e.transaction(t,n)})},t.prototype.store=function(t){return new a(t,this)},t.prototype.remove=function(){return o(indexDB.deleteDatabase(u)).then(function(){return u=h=f=s=r=e=null})},t.prototype.batch=function(){var t,n;return n=1<=arguments.length?w.call(arguments,0):[],e=null,t=null,this.getIDBTransaction(n,"readonly").then(function(n){return e=n,null!==t?t():void 0}),{run:function(n){return function(r){return t=function(){try{return r(n)}finally{t=null,e=null}},null!==e&&t(),i(e)}}(this)}},p=function(t){var e,r,o,u,i,s,c,a,l,h,p,d,y,m,g,w,b,D;if(null===f)throw new n("Schema not found.");if(r=[],o=t.objectStoreNames,o.length>0)for(D=t.transaction(o,"readwrite"),u=function(e){var o,u,i,s,c,a,l;if(f.stores.hasOwnProperty(e)){for(a=D.objectStore(e),o=a.indexNames,l=f.stores[e],c=[],i=0,s=o.length;s>i;i++)u=o[i],c.push(function(t){var e,o;if(!l.indexes.hasOwnProperty(t))return r.push(function(){return a.deleteIndex(t)});if(e=a.index(t),o=l.indexes[t],!e.unique&&o.option.unique)throw new n("Turning existed index("+t+") to be unique is not allowed.");return e.keyPath!==o.key||e.unique!==o.option.unique||e.multiEntry!==o.option.multiEntry?(r.push(function(){return a.deleteIndex(t)}),r.push(function(){return a.createIndex(t,o.key,o.option)})):void 0}(u));return c}return r.push(function(){return t.deleteObjectStore(e)})},s=0,h=o.length;h>s;s++)w=o[s],u(w);d=f.stores;for(w in d)if(b=d[w],I.call(o,w)<0){g=t.createObjectStore(w,b.option),y=b.indexes,i=function(t,e,n){return r.push(function(){return t.createIndex(e,n.key,n.option)})};for(c in y)a=y[c],i(g,c,a)}for(m=[],l=0,p=r.length;p>l;l++)e=r[l],m.push(e());return m},t}(),e=function(){var e,r;return r={},e=function(e){return r.hasOwnProperty(e)||(r[e]=new t(e)),r[e]},e.Error=n,e}(),"function"==typeof define&&null!=define.amd)define("IDB",e);else if(null!=("undefined"!=typeof module&&null!==module?module.exports:void 0))module.exports=e;else if(this.hasOwnProperty("IDB"))if(this.hasOwnProperty("$IDB")){if(h="Fail to export IDB: name 'IDB' and '$IDB' is in use.","function"!=typeof("undefined"!=typeof console&&null!==console?console.error:void 0))throw h;console.error(h)}else this.$IDB=e;else this.IDB=e}).call(this);