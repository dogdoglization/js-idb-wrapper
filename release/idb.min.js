(function(){var e,t,n,r,o,i,u,a,c,s,l,f,p,h=function(e,t){function n(){this.constructor=e}for(var r in t)d.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},d={}.hasOwnProperty,y=[].slice,m=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};if(l=window||self||global||this,f=l.indexedDB||l.mozIndexedDB||l.webkitIndexedDB||l.msIndexedDB,i=l.IDBTransaction||l.webkitIDBTransaction||l.msIDBTransaction,r=l.IDBKeyRange||l.webkitIDBKeyRange||l.msIDBKeyRange,o=function(e){var t;return t=newDefer(),e.onsuccess=function(e){return t.resolve(e)},e.onerror=function(e){return t.reject(e)},t.promise},u=function(e){var t;return t=newDefer(),e.onComplete=function(e){return t.resolve(e)},e.onerror=e.onabort=function(e){return t.reject(e)},t.promise},n=function(e){function t(e){this.message=e}return h(t,e),t}(Error),c=function(){function e(e){var o,i,u,a,c,s,l,f,p,h;for(h in e){if(p=e[h],"string"!=typeof h)throw new n("Store name must be string.");if(!("object"==typeof p&&p instanceof Array))throw new n("The definition of store("+h+") must be in array.");for(f=new this.Store(h),i=0,l=p.length;l>i;i++){if(o=p[i],"string"!=typeof o)throw new n("Index definition must be in string form.");if(o=o.trim().replace(/(\s|\t)+/g," ").replace(/\s?\(\s?/g,"(").replace(/\s?\)\s?/g,")").replace(/\s?,\s?/g,",").replace(/\s?.\s?/g,"."),o.match(/^KEY/)){if(null!=f.option.keyPath)throw new n("Store key duplicated.");o.match(/^KEY\(.+\)/)&&(f.option.keyPath=r(o.slice(4,o.indexOf(")")))),o.match(/( AUTO)$/)&&(f.option.autoIncrement=!0)}else{if(u=o.replace(/\(.+\)/,"").replace(/( UNIQUE)$/,""),!u.match(/(\w|\.)+/))throw new n("Invalid index name("+u+").");c=o.match(/( UNIQUE)$/)?!0:!1,a=!1,s=function(){if(o.match(/^.+\(.+\)/)){if(o.indexOf(",")>-1&&(a=!0),a&&o.indexOf("+")>-1)throw new n("Fail to parse definition("+string+"): ',' and '+' cannot state in the same definition.");return r(o.slice(o.indexOf("(")+1,o.indexOf(")")))}return t(u)}(),f.addIndex(u,s,c,a)}}this.stores[h]=f}}var t,r;return e.prototype.stores={},e.Store=function(){function e(e){this.name=e,this.option={keyPath:null,autoIncrement:null},this.indexes={}}return e.prototype.addIndex=function(e,t,r,o){if(this.indexes[e])throw new n("index("+e+") duplicated at ObjectStore("+this.name+").");this.indexes[e]={name:e,key:t,option:{unique:r,multiEntry:o}}},e}(),r=function(e){var t,o,i,u,a;if(e.search(/(,|\+)/)>-1){for(u=e.split(/(,|\+)/),a=[],t=0,i=u.length;i>t;t++)o=u[t],a.push(r(o));return a}if(e.indexOf(".")>-1&&(e=e.replace(".",",")),e.match(/^(\'\'|\"\")$/))return"";if(e.match(/(\'|\")/g))throw new n("Fail to parse definition("+e+"): quotation mark not in pairs.");return e},t=function(e){return e.indexOf(".")>-1?e.split("."):e},e}(),a=function(){function e(e,n,o){i=e,t=null!=n?n:e.key(),r=o}var t,n,r,i;return i=t=r=n=null,e.prototype.order=function(e){return n=-1===e||"string"==typeof e&&e.match(/desc/)?"prev":null,this},e.prototype.each=function(e){var r,o,u;return r=newDefer(),o=i.getIDBObjectStore("readonly").index(t),u=o.openCursor(range,n),u.onsuccess=function(t){var n,o;if(!(n=t.target.result))return r.resolve(t);try{return e(n.key,n.value,t)===!1?r.resolve(t):n["continue"]()}catch(i){return o=i,r.reject(o)}},u.onerror=function(e){return r.reject(e)},r.promise},e.prototype.first=function(e){var n;return n=i.getIDBObjectStore("readonly").index(t),o(n.get(range)).then(function(t){return e(t.target.result)})},e.prototype.list=function(e){var t;return t=[],this.each(function(e){return t.push(e)}).then(e(t))},e.prototype.count=function(e){var n;return n=i.getIDBObjectStore("readonly").index(t),o(n.count(r)).then(function(t){return e(t.target.result)})},e}(),s=function(){function e(){}var t,i,u,c;return i=t={constructor:function(e,n){return i=e,t=n}},u=function(e){return null==e&&(e="readwrite"),t.getIDBTransaction(i,e).then(function(e){return e.objectStore(i)})},e.prototype.key=function(){return this.getIDBObjectStore("readonly").keyPath},e.prototype.name=function(){return i},e.prototype.indexes=function(){return this.getIDBObjectStore("readonly").indexNames},e.prototype.isAutoIncrement=function(){return this.getIDBObjectStore("readonly").autoIncrement},e.prototype.add=function(){var e;return e=1<=arguments.length?y.call(arguments,0):[],this.getIDBObjectStore().then(function(t){return o(t.add.apply(t,e))})},e.prototype.update=function(){var e;return e=1<=arguments.length?y.call(arguments,0):[],this.getIDBObjectStore().then(function(t){return o(t.put.apply(t,e))})},e.prototype["delete"]=function(e){return this.getIDBObjectStore().then(function(t){return o(t["delete"](e))})},e.prototype.clear=function(){return this.getIDBObjectStore().then(function(e){return o(e.clear())})},e.prototype.where=function(e){var t,o,i,u,s,l,f,p,h,d,y,m,g,b,w,I,D,v;switch(t=e.trim().replace(/(\s|\t)+/g,""),!1){case!t.match(/^.+=.+$/):s=t.split("="),o=s[0],u=s[1],u=r.only(c(u));break;case!t.match(/^.+<.+$/):l=t.split("<"),o=l[0],u=l[1],u=r.upperBound(c(u,!0));break;case!t.match(/^.+<=.+$/):d=t.split("<="),o=d[0],u=d[1],u=r.upperBound(c(u));break;case!t.match(/^.+>.+$/):y=t.split(">"),o=y[0],u=y[1],u=r.lowerBound(c(u,!0));break;case!t.match(/^.+>=.+$/):m=t.split(">="),o=m[0],u=m[1],u=r.lowerBound(c(u));break;case!t.match(/^.+<.+<.+$/):g=t.split("<"),i=g[0],o=g[1],v=g[2],u=r.bound(c(i,c(v,!0,!0)));break;case!t.match(/^.+<=.+<.+$/):b=t.split(/<\=?/),i=b[0],o=b[1],v=b[2],u=r.bound(c(i,c(v,!1,!0)));break;case!t.match(/^.+<.+<=.+$/):w=t.split("<=?"),i=w[0],o=w[1],v=w[2],u=r.bound(c(i,c(v,!0)));break;case!t.match(/^.+<=.+<=.+$/):I=t.split("<="),i=I[0],o=I[1],v=I[2],u=r.bound(c(i,c(v)));break;case!t.match(/^.+>.+>.+$/):D=t.split(">"),v=D[0],o=D[1],i=D[2],u=r.bound(c(i,c(v,!0,!0)));break;case!t.match(/^.+>=.+>.+$/):f=t.split(/>\=?/),v=f[0],o=f[1],i=f[2],u=r.bound(c(i,c(v,!1,!0)));break;case!t.match(/^.+>.+>=.+$/):p=t.split(">=?"),v=p[0],o=p[1],i=p[2],u=r.bound(c(i,c(v,!0)));break;case!t.match(/^.+>=.+>=.+$/):h=t.split(">="),v=h[0],o=h[1],i=h[2],u=r.bound(c(i,c(v)));break;default:throw new n("Unknown statment ("+e+").")}return new a(this,o,u)},c=function(e){var t,n,r,o,i;if(e.match(/^\[.*\]$/)){for(r=e.slice(1,-1).match(/(\[.+\]|'.+'|".+"|[^,]+)/g),o=[],t=0,n=r.length;n>t;t++)i=r[t],o.push(c(i));return o}return isNaN(e)?e.match(/^('|").+('|")$/)?e.slice(1,-1):e:+e},e}(),e=function(){function e(e){i=e}var t,r,i,a,l,p,h;return i=p=l=a=r=t=null,e.prototype.name=function(){return i},e.prototype.version=function(e,t){return e?null===p||e>=p?l=new c(t):void 0:p},e.prototype.onVersionConflict=function(e){return a=e},e.prototype.getIDBDatabase=function(){var e;return null!=r?newDefer().resolve(r).promise:(e=f.open(i,p),e.onblocked=a,e.onupgradeneeded=function(e){return h(e.target.result)},o(e).then(function(e){return r=e.target.result}))},e.prototype.getIDBTransaction=function(e,n){return t?newDefer().resolve(t).promise:this.getIDBDatabase().then(function(t){return t.transaction(e,n)})},e.prototype.store=function(e){return new s(e,this)},e.prototype.remove=function(){return o(indexDB.deleteDatabase(i)).then(function(){return i=p=l=a=r=t=null})},e.prototype.batch=function(){var e,n;return n=1<=arguments.length?y.call(arguments,0):[],t=null,e=null,this.getIDBTransaction(n,"readonly").then(function(n){return t=n,null!==e?e():void 0}),{run:function(n){return function(r){return e=function(){try{return r(n)}finally{e=null,t=null}},null!==t&&e(),u(t)}}(this)}},h=function(e){var t,r,o,i,u,a,c,s,f,p,h,d,y,g,b,w,I,D,v;if(null===l){for(r=[],i=db.objectStoreNames,v=db.transaction(i,"readwrite"),u=0,h=i.length;h>u;u++)if(I=i[u],l.stores.hasOwnProperty(I))for(w=v.objectStore(I),o=w.indexNames,D=l.stores[I],f=0,d=o.length;d>f;f++)if(c=o[f],D.indexes.hasOwnProperty(c)){if(a=w.index(c),s=D.indexes[c],!a.unique&&s.option.unique)throw new n("Turning existed index("+c+") to be unique is not allowed.");(a.keyPath!==s.key||a.unique!==s.option.unique||a.multiEntry!==s.option.multiEntry)&&(r.push(function(){return w.deleteIndex(c)}),r.push(function(){return w.createIndex(c,s.key,s.option)}))}else r.push(function(){return w.deleteIndex(c)});else r.push(function(){return db.deleteObjectStore(I)});g=l.stores;for(I in g)if(D=g[I],m.call(i,I)<0){w=db.createObjectStore(I,D.option);for(c in D)s=D[c],r.push(function(){return w.createIndex(c,s.key,s.option)})}for(b=[],p=0,y=r.length;y>p;p++)t=r[p],b.push(t());return b}},e}(),t=function(){var t,r;return r={},t=function(t){return r.hasOwnProperty(t)||(r[t]=new e(t)),r[t]},t.Error=n,t}(),"function"==typeof define&&null!=define.amd)define("IDB",t);else if(null!=("undefined"!=typeof module&&null!==module?module.exports:void 0))module.exports=t;else if(this.hasOwnProperty("IDB"))if(this.hasOwnProperty("$IDB")){if(p="Fail to export IDB: name 'IDB' and '$IDB' is in use.","function"!=typeof("undefined"!=typeof console&&null!==console?console.error:void 0))throw p;console.error(p)}else this.$IDB=t;else this.IDB=t}).call(this);