(function(){var t,e,n,r,i,o,s,u,a,c,f,h,l,d,p,m,y=function(t,e){function n(){this.constructor=t}for(var r in e)b.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},b={}.hasOwnProperty,g=[].slice,w=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};if(f=window||self||global||this,"undefined"!=typeof f.Promise)d=function(){var t;return t={},t.promise=new Promise(function(e,n){return t.resolve=e,t.reject=n}),t},m=function(t){return t.promise};else if("undefined"!=typeof f.Q)d=function(){return Q.defer()},m=function(t){return t.promise};else{if("undefined"==typeof f.jQuery)throw new n("Not compatible promise function found.");d=function(){return jQuery.Deferred()},m=function(t){return t.promise({"catch":function(t){return this.fail(t)}})}}if(p=function(t,e){var n;if(n=d(),t)n.resolve(t);else{if(!e)throw new Error("either result or error must provided to newPromise().");n.reject(e)}return m(n)},h=f.indexedDB||f.mozIndexedDB||f.webkitIndexedDB||f.msIndexedDB,o=f.IDBTransaction||f.webkitIDBTransaction||f.msIDBTransaction,r=f.IDBKeyRange||f.webkitIDBKeyRange||f.msIDBKeyRange,i=function(t){var e;return e=d(),t.onsuccess=function(t){return e.resolve(t)},t.onerror=function(t){return e.reject(t)},m(e)},s=function(t){var e;return e=d(),t.onComplete=function(t){return e.resolve(t)},t.onerror=t.onabort=function(t){return e.reject(t)},m(e)},n=function(t){function e(t){this.message=t,console.error("IDBError: "+this.message)}return y(e,t),e}(Error),a=function(){function t(t){this.stores={},this.applyDefinition(t)}var e,r;return t.Store=function(){function t(t){this.name=t,this.option={keyPath:null,autoIncrement:null},this.indexes={}}return t.prototype.addIndex=function(t,e,r,i){if(this.indexes.hasOwnProperty(t))throw new n("index("+t+") duplicated at ObjectStore("+this.name+").");this.indexes[t]={name:t,key:e,option:{unique:r,multiEntry:i}}},t}(),t.prototype.applyDefinition=function(t){var i,o,s,u,a,c,f,h,l,d,p;if("object"!=typeof t)throw new n("The database definition must be JSON.");h=[];for(p in t){if(d=t[p],"string"!=typeof p)throw new n("Store name must be string.");if(!("object"==typeof d&&d instanceof Array))throw new n("The definition of store("+p+") must be in array.");for(l=new this.constructor.Store(p),o=0,f=d.length;f>o;o++){if(i=d[o],"string"!=typeof i)throw new n("Index definition must be in string form.");if(i=i.trim().replace(/(\s|\t)+/g," ").replace(/\s?\(\s?/g,"(").replace(/\s?\)\s?/g,")").replace(/\s?,\s?/g,",").replace(/\s?\+\s?/g,"+").replace(/\s?\.\s?/g,"."),i.match(/^KEY/)){if(null!=l.option.keyPath)throw new n("Store key duplicated.");i.match(/^KEY\(.+\)/)&&(l.option.keyPath=r(i.slice(4,i.indexOf(")")))),i.match(/AUTO$/)&&(l.option.autoIncrement=!0)}else{if(s=i.replace(/\(.+\)/,"").replace(/( UNIQUE)$/,""),!s.match(/(\w|\.)+/))throw new n("Invalid index name("+s+").");a=i.match(/( UNIQUE)$/)?!0:!1,u=!1,c=function(){if(i.match(/^.+\(.+\)/)){if(i.indexOf(",")>-1&&(u=!0),u&&i.indexOf("+")>-1)throw new n("Fail to parse definition("+string+"): ',' and '+' cannot state in the same definition.");return r(i.slice(i.indexOf("(")+1,i.indexOf(")")))}return e(s)}(),l.addIndex(s,c,a,u)}}h.push(this.stores[p]=l)}return h},r=function(t){var e,i,o,s,u,a,c,f,h;if(t.indexOf(",")>-1){for(a=t.split(","),f=[],e=0,s=a.length;s>e;e++)o=a[e],f.push(r(o));return f}if(t.indexOf("+")>-1){for(c=t.split("+"),h=[],i=0,u=c.length;u>i;i++)o=c[i],h.push(r(o));return h}if(t.indexOf(".")>-1&&(t=t.replace(".",",")),t.match(/^(\'\'|\"\")$/))return"";if(t.match(/(\'|\")/g))throw new n("Fail to parse definition("+t+"): quotation mark not in pairs.");return t},e=function(t){return t.indexOf(".")>-1?t.split("."):t},t}(),u=function(){function t(t,e,n){this._store=t,this._indexName=e,this._range=n,this._limitTo=null,this._limitFrom=0,this._order="next"}return t.prototype.getIDBIndexIfSet=function(t){var e,n;if("remark"!==this._indexName)return this._indexName?t.index(this._indexName):t;try{return n=t.index(this._indexName),console.log(n),n}catch(r){throw e=r,console.error(e),e}},t.prototype.order=function(t){return this._order=-1===t||"string"==typeof t&&t.match(/desc/i)?"prev":"next",this},t.prototype.limit=function(){var t,e,r,i;return t=1<=arguments.length?g.call(arguments,0):[],i=function(){switch(t.length){case 1:if(r=t[0],"number"!=typeof r||1>r)throw new n("length must be > 0 for Query.limit()");return[0,r-1];case 2:if(e=t[0],r=t[1],"number"!=typeof e||0>e)throw new n("starting position must be > -1 for Query.limit()");if("number"!=typeof r||1>r)throw new n("length must be > 0 for Query.limit()");return[e,e+r-1];default:throw new n("wrong usage of Query.limit()")}}(),this._limitFrom=i[0],this._limitTo=i[1],this},t.prototype.each=function(t){return this._store.getIDBObjectStore("readonly").then(function(e){return function(n){var r,i,o;return i=d(),r=0,o=[],e.getIDBIndexIfSet(n).openCursor(e._range,e._order).onsuccess=function(n){var s,u,a;if(!(s=n.target.result))return i.resolve(o);if(r<e._limitFrom)return s.advance(r=e._limitFrom);if(null!==e._limitTo&&r>e._limitTo)return i.resolve(o);try{return a=t(s.value,s.key),void 0!==a&&o.push(a),r++,s["continue"]()}catch(c){return u=c,i.reject(u)}},m(i)}}(this))},t.prototype.first=function(t){return this.limit(1).each(function(t,e){return[t,e]}).then(function(e){return t(e[0][0],e[0][1])})},t.prototype.list=function(t){var e,n;return n=[],e=[],this.each(function(t,r){return n.push(t),e.push(r)}).then(function(){return t(n,e)})},t.prototype.count=function(t){return this._store.getIDBObjectStore("readonly").then(function(t){return function(e){return i(t.getIDBIndexIfSet(e).count(t._range))}}(this)).then(function(e){return t(e.target.result)})},t}(),c=function(){function t(t,e){this._name=t,this._db=e}var e;return t.prototype.getIDBObjectStore=function(t){return null==t&&(t="readwrite"),this._db.getIDBTransaction(this._name,t).then(function(t){return function(e){return e.objectStore(t._name)}}(this))},t.prototype.key=function(){return this.getIDBObjectStore("readonly").then(function(t){return t.keyPath})},t.prototype.name=function(){return this.getIDBObjectStore("readonly").then(function(t){return t.name})},t.prototype.indexes=function(){return this.getIDBObjectStore("readonly").then(function(t){return t.indexNames})},t.prototype.isAutoKey=function(){return this.getIDBObjectStore("readonly").then(function(t){return t.autoIncrement})},t.prototype.add=function(){var t;return t=1<=arguments.length?g.call(arguments,0):[],this.getIDBObjectStore().then(function(e){return i(e.add.apply(e,t))})},t.prototype.update=function(){var t;return t=1<=arguments.length?g.call(arguments,0):[],this.getIDBObjectStore().then(function(e){return i(e.put.apply(e,t))})},t.prototype["delete"]=function(t){return this.getIDBObjectStore().then(function(e){return i(e["delete"](t))})},t.prototype.clear=function(){return this.getIDBObjectStore().then(function(t){return i(t.clear())})},t.prototype.where=function(t){var i,o,s,a;return"string"==typeof t&&(t=t.trim()),a=function(){switch(!1){case!(null===t||""===t):return[null,null];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*<=[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*<=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(o[2]),r.bound(e(o[1]),e(o[3]))];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*<[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*<=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(o[2]),r.bound(e(o[1]),e(o[3]),!0)];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*<=[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*<[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(o[2]),r.bound(e(o[1]),e(o[3]),!1,!0)];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*<[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*<[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(o[2]),r.bound(e(o[1]),e(o[3]),!0,!0)];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*>=[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*>=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(o[2]),r.bound(e(o[3]),e(o[1]))];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*>[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*>=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(o[2]),r.bound(e(o[3]),e(o[1]),!0)];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*>=[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*>[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(o[2]),r.bound(e(o[3]),e(o[1]),!1,!0)];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*>[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*>[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(o[2]),r.bound(e(o[3]),e(o[1]),!0,!0)];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*<=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(o[1]),r.upperBound(e(o[2]))];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*<[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(o[1]),r.upperBound(e(o[2]),!0)];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*>=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(o[1]),r.lowerBound(e(o[2]))];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*>[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(o[1]),r.lowerBound(e(o[2]),!0)];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(o[1]),r.only(e(o[2]))];case!(o=t.match(/^('.*'|".*"|[^\s\t]+)$/)):return[e(o[1]),null];default:throw new n("Unknown statment ("+t+").")}}(),i=a[0],s=a[1],new u(this,i,s)},t.prototype.all=function(){return this.where(null)},e=function(t){var n,r,i,o,s;if(t.match(/^\[.*\]$/)){for(i=t.slice(1,-1).match(/(\[.+\]|'.*'|".*"|[^,]+)/g),o=[],n=0,r=i.length;r>n;n++)s=i[n],o.push(e(s.trim()));return o}return isNaN(t)?t.match(/^('.*'|".*")$/)?t.slice(1,-1):t:+t},t}(),t=function(){function t(t){this._name=t,this._version=null,this._dbDefinition=null,this._onVersionConflictHandler=null,this._idbDatabase=null,this._batchTx=null}return t.prototype.name=function(){return this.getIDBDatabase().then(function(t){return t.name})},t.prototype.version=function(t,e){return t?null===this._version||this._version<=t?(this._dbDefinition=e,this._version=t,this):void 0:this.getIDBDatabase().then(function(t){return t.version})},t.prototype.onVersionConflict=function(t){return this._onVersionConflictHandler=t},t.prototype.getIDBDatabase=function(){var t;return null!=this._idbDatabase?p(this._idbDatabase):(t=h.open(this._name,this._version),t.onblocked=this._onVersionConflictHandler,t.onupgradeneeded=function(t){return function(e){return t.doUpgrade(e.target.result)}}(this),i(t).then(function(t){return function(e){return t._idbDatabase=e.target.result}}(this)))},t.prototype.getIDBTransaction=function(t,e){return this._batchTx?p(this._batchTx):this.getIDBDatabase().then(function(n){return n.transaction(t,e)})},t.prototype.store=function(t){return new c(t,this)},t.prototype.close=function(){this._idbDatabase&&(this._idbDatabase.close(),this._idbDatabase=null)},t.prototype.remove=function(){return i(indexDB.deleteDatabase(_name)).then(function(t){return function(){return t._name=t._version=t._dbDefinition=t._onVersionConflictHandler=t._idbDatabase=t._batchTx=null}}(this))},t.prototype.batch=function(){var t,e;return e=1<=arguments.length?g.call(arguments,0):[],this._batchTx=null,t=this.getIDBTransaction(e,"readwrite").then(function(t){return function(e){return t._batchTx=e}}(this)),t.run=function(e){return function(e){return t.then(function(){try{return e(this)}finally{this._batchTx=null}})}}(this),t},t.prototype.doUpgrade=function(t){var e,r,i,o,s,u,c,f,h,l,d,p,m,y,b,g,_,D,x;if(null===this._dbDefinition)throw new n("DB definition not found.");if(e=new a(this._dbDefinition),i=[],o=t.objectStoreNames,o.length>0)for(x=t.transaction(o,"readwrite"),s=function(r){var o,s,u,a,c,f,h;if(e.stores.hasOwnProperty(r)){for(f=x.objectStore(r),o=f.indexNames,h=e.stores[r],c=[],u=0,a=o.length;a>u;u++)s=o[u],c.push(function(t){var e,r;if(!h.indexes.hasOwnProperty(t))return i.push(function(){return f.deleteIndex(t)});if(e=f.index(t),r=h.indexes[t],!e.unique&&r.option.unique)throw new n("Turning existed index("+t+") to be unique is not allowed.");return e.keyPath!==r.key||e.unique!==r.option.unique||e.multiEntry!==r.option.multiEntry?(i.push(function(){return f.deleteIndex(t)}),i.push(function(){return f.createIndex(t,r.key,r.option)})):void 0}(s));return c}return i.push(function(){return t.deleteObjectStore(r)})},c=0,d=o.length;d>c;c++)_=o[c],s(_);m=e.stores;for(_ in m)if(D=m[_],w.call(o,_)<0){g=t.createObjectStore(_,D.option),y=D.indexes,u=function(t,e,n){return i.push(function(){return t.createIndex(e,n.key,n.option)})};for(f in y)h=y[f],u(g,f,h)}for(b=[],l=0,p=i.length;p>l;l++)r=i[l],b.push(r());return b},t}(),e=function(){var e,r;return r={},e=function(e){return r.hasOwnProperty(e)||(r[e]=new t(e)),r[e]},e.Error=n,e}(),"function"==typeof define&&null!=define.amd)define("IDB",e);else if(null!=("undefined"!=typeof module&&null!==module?module.exports:void 0))module.exports=e;else if(this.hasOwnProperty("IDB"))if(this.hasOwnProperty("$IDB")){if(l="Fail to export IDB: name 'IDB' and '$IDB' is in use.","function"!=typeof("undefined"!=typeof console&&null!==console?console.error:void 0))throw l;console.error(l)}else this.$IDB=e;else this.IDB=e}).call(this);