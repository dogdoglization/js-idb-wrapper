(function(){var t,e,n,r,o,i,u,s,a,c,f,h,l,p,d,m,y=function(t,e){function n(){this.constructor=t}for(var r in e)b.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},b={}.hasOwnProperty,g=[].slice,_=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};if(f=window||self||global||this,"undefined"!=typeof f.Promise)l=function(){var t;return t={},t.promise=new Promise(function(e,n){return t.resolve=e,t.reject=n}),t},m=function(t){return t.promise};else if("undefined"!=typeof f.Q)l=function(){return Q.defer()},m=function(t){return t.promise};else{if("undefined"==typeof f.jQuery)throw new n("Not compatible promise function found.");l=function(){return jQuery.Deferred()},m=function(t){return t.promise({"catch":function(t){return this.fail(t)}})}}p=function(t,e){var n;if(n=l(),t)n.resolve(t);else{if(!e)throw new Error("either result or error must provided to newPromise().");n.reject(e)}return m(n)},h=f.indexedDB||f.mozIndexedDB||f.webkitIndexedDB||f.msIndexedDB,i=f.IDBTransaction||f.webkitIDBTransaction||f.msIDBTransaction,r=f.IDBKeyRange||f.webkitIDBKeyRange||f.msIDBKeyRange,o=function(t){var e;return e=l(),t.onsuccess=function(t){return e.resolve(t)},t.onerror=function(t){return e.reject(t)},m(e)},u=function(t){var e;return e=l(),t.onComplete=function(t){return e.resolve(t)},t.onerror=t.onabort=function(t){return e.reject(t)},m(e)},n=function(t){function e(t){this.message=t,console.error("IDBError: "+this.message)}return y(e,t),e}(Error),a=function(){function t(t){this.stores={},this.applyDefinition(t)}var e;return t.Store=function(){function t(t){this.name=t,this.option={keyPath:null,autoIncrement:null},this.indexes={}}return t.prototype.addIndex=function(t,e,r,o){if(this.indexes.hasOwnProperty(t))throw new n("index("+t+") duplicated at ObjectStore("+this.name+").");this.indexes[t]={name:t,key:e,option:{unique:r,multiEntry:o}}},t}(),t.prototype.applyDefinition=function(t){var r,o,i,u,s,a,c,f,h,l,p,d;if("object"!=typeof t)throw new n("The database definition must be JSON.");h=[];for(d in t){if(p=t[d],"string"!=typeof d)throw new n("Store name must be string.");if(!("object"==typeof p&&p instanceof Array))throw new n("The definition of store("+d+") must be in array.");for(l=new this.constructor.Store(d),o=0,c=p.length;c>o;o++){if(r=p[o],"string"!=typeof r)throw new n("Index definition must be in string form.");if(r=r.trim().replace(/[\s\t]+/g," ").replace(/\s?\(\s?/g,"(").replace(/\s?\)\s?/g,")").replace(/\s?\.\s?/g,"."),r.match(/^KEY/)){if(null!=l.option.keyPath)throw new n("Store key duplicated.");(f=r.match(/^KEY(\(.+\)).*$/))&&(l.option.keyPath=e(f[1])),r.match(/AUTO$/)&&(l.option.autoIncrement=!0)}else{if(i=r.replace(/[\(\s].+/,""),!i.match(/(\w|\.)+/))throw new n("Invalid index name("+i+").");s=r.match(/[\s\)]UNIQUE/g)?!0:!1,u=r.match(/[\s\)]ARRAY/g)?!0:!1,a=(f=r.match(/.+(\(.+\)).*/))?e(f[1]):i,l.addIndex(i,a,s,u)}}h.push(this.stores[d]=l)}return h},e=function(t){var n,r,o,i;return(i=t.indexOf("("))>-1?(t=t.slice(i+1,t.lastIndexOf(")")),(r=t.match(/[^,]+/g))?(n=function(){var t,n,i;for(i=[],t=0,n=r.length;n>t;t++)o=r[t],i.push(e(o.trim()));return i}(),1===n.length?n[0]:n):t):t},t}(),s=function(){function t(t,e,n){this._store=t,this._indexName=e,this._range=n,this._limitTo=null,this._limitFrom=0,this._order="next"}return t.prototype.getIDBIndexIfSet=function(t){return null!==this._indexName?t.index(this._indexName):t},t.prototype.order=function(t){return this._order=-1===t||"string"==typeof t&&t.match(/desc/i)?"prev":"next",this},t.prototype.limit=function(){var t,e,r,o;return t=1<=arguments.length?g.call(arguments,0):[],o=function(){switch(t.length){case 1:if(r=t[0],"number"!=typeof r||1>r)throw new n("length must be > 0 for Query.limit()");return[0,r-1];case 2:if(e=t[0],r=t[1],"number"!=typeof e||0>e)throw new n("starting position must be > -1 for Query.limit()");if("number"!=typeof r||1>r)throw new n("length must be > 0 for Query.limit()");return[e,e+r-1];default:throw new n("wrong usage of Query.limit()")}}(),this._limitFrom=o[0],this._limitTo=o[1],this},t.prototype.each=function(t){return this._store.getIDBObjectStore("readonly").then(function(e){return function(n){var r,o,i;return o=l(),r=0,i=[],e.getIDBIndexIfSet(n).openCursor(e._range,e._order).onsuccess=function(n){var u,s,a;if(!(u=n.target.result))return o.resolve(i);if(r<e._limitFrom)return u.advance(r=e._limitFrom);if(null!==e._limitTo&&r>e._limitTo)return o.resolve(i);try{return a=t(u.value,u.key),void 0!==a&&i.push(a),r++,u["continue"]()}catch(c){return s=c,o.reject(s)}},m(o)}}(this))},t.prototype.first=function(t){return this.limit(1).each(function(t,e){return[t,e]}).then(function(e){return e.length>0?t(e[0][0],e[0][1]):t(null,null)})},t.prototype.list=function(t){var e,n;return n=[],e=[],this.each(function(t,r){return n.push(t),e.push(r)}).then(function(){return t(n,e)})},t.prototype.count=function(t){return this._store.getIDBObjectStore("readonly").then(function(t){return function(e){return o(t.getIDBIndexIfSet(e).count(t._range))}}(this)).then(function(e){return t(e.target.result)})},t}(),c=function(){function t(t,e){this._name=t,this._db=e}var e;return t.prototype.getIDBObjectStore=function(t){return null==t&&(t="readwrite"),this._db.getIDBTransaction(this._name,t).then(function(t){return function(e){return e.objectStore(t._name)}}(this))},t.prototype.key=function(){return this.getIDBObjectStore("readonly").then(function(t){return t.keyPath})},t.prototype.name=function(){return this.getIDBObjectStore("readonly").then(function(t){return t.name})},t.prototype.indexes=function(){return this.getIDBObjectStore("readonly").then(function(t){return t.indexNames})},t.prototype.isAutoKey=function(){return this.getIDBObjectStore("readonly").then(function(t){return t.autoIncrement})},t.prototype.add=function(){var t;return t=1<=arguments.length?g.call(arguments,0):[],this.getIDBObjectStore().then(function(e){return o(e.add.apply(e,t))})},t.prototype.update=function(){var t;return t=1<=arguments.length?g.call(arguments,0):[],this.getIDBObjectStore().then(function(e){return o(e.put.apply(e,t))})},t.prototype["delete"]=function(t){return this.getIDBObjectStore().then(function(e){return o(e["delete"](t))})},t.prototype.clear=function(){return this.getIDBObjectStore().then(function(t){return o(t.clear())})},t.prototype.where=function(t){var o,i,u,a;return"string"==typeof t&&(t=t.trim()),a=function(){switch(!1){case!(null===t||""===t):return[null,null];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*<=[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*<=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(i[2]),r.bound(e(i[1]),e(i[3]))];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*<[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*<=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(i[2]),r.bound(e(i[1]),e(i[3]),!0)];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*<=[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*<[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(i[2]),r.bound(e(i[1]),e(i[3]),!1,!0)];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*<[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*<[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(i[2]),r.bound(e(i[1]),e(i[3]),!0,!0)];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*>=[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*>=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(i[2]),r.bound(e(i[3]),e(i[1]))];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*>[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*>=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(i[2]),r.bound(e(i[3]),e(i[1]),!0)];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*>=[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*>[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(i[2]),r.bound(e(i[3]),e(i[1]),!1,!0)];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*>[\s\t]*('.*'|".*"|[^\s\t]+)[\s\t]*>[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(i[2]),r.bound(e(i[3]),e(i[1]),!0,!0)];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*<=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(i[1]),r.upperBound(e(i[2]))];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*<[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(i[1]),r.upperBound(e(i[2]),!0)];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*>=[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(i[1]),r.lowerBound(e(i[2]))];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*>[\s\t]*('.*'|".*"|[^\s\t]+)$/)):return[e(i[1]),r.lowerBound(e(i[2]),!0)];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)[\s\t]*=[\s\t]*('.*'|".*"|\[.*\]|[^\s\t]+)$/)):return[e(i[1]),r.only(e(i[2]))];case!(i=t.match(/^('.*'|".*"|[^\s\t]+)$/)):return[e(i[1]),null];default:throw new n("Unknown statment ("+t+").")}}(),o=a[0],u=a[1],new s(this,o,u)},t.prototype.all=function(){return this.where(null)},e=function(t){var n,r,o,i,u;if(t.match(/^\[.*\]$/)){for(o=t.slice(1,-1).match(/(\[.+\]|'.*'|".*"|[^,]+)/g),i=[],n=0,r=o.length;r>n;n++)u=o[n],i.push(e(u.trim()));return i}return isNaN(t)?t.match(/^('.*'|".*")$/)?t.slice(1,-1):t:+t},t}(),t=function(){function t(t){this._name=t,this._version=null,this._dbDefinition=null,this._idbDatabase=null,this._batchTx=null,this._onVersionConflictHandler=function(t){throw t}}return t.prototype.name=function(){return this.getIDBDatabase().then(function(t){return t.name})},t.prototype.version=function(t,e){return t?null===this._version||this._version<=t?(this._dbDefinition=e,this._version=t,null!==this._idbDatabase&&(this._idbDatabase.close(),this._idbDatabase=this._batchTx=null),this):void 0:this.getIDBDatabase().then(function(t){return t.version})},t.prototype.onVersionConflict=function(t){return this._onVersionConflictHandler=t},t.prototype.getIDBDatabase=function(){var t;return null!=this._idbDatabase?p(this._idbDatabase):(t=h.open(this._name,this._version),t.onupgradeneeded=function(t){return function(e){return t.doUpgrade(e.target.result,e.target.transaction)}}(this),t.onblocked=function(t){return function(e){if(e.newVersion===t._version);else if("function"==typeof t._onVersionConflictHandler)return t._onVersionConflictHandler(e)}}(this),o(t).then(function(t){return function(e){return t._idbDatabase=e.target.result}}(this)))},t.prototype.getIDBTransaction=function(t,e){return this._batchTx?p(this._batchTx):this.getIDBDatabase().then(function(n){return n.transaction(t,e)})},t.prototype.store=function(t){return new c(t,this)},t.prototype.close=function(){return this._idbDatabase.close(),this._idbDatabase=this._batchTx=null},t.prototype.remove=function(){var t,e;return e=h.deleteDatabase(this._name),t=l(),e.onblocked=t.resolve,e.onerror=t.reject,e.onsuccess=t.resolve,m(t).then(function(t){return function(){return t._name=t._version=t._dbDefinition=t._onVersionConflictHandler=t._idbDatabase=t._batchTx=null}}(this))},t.prototype.batch=function(){var t,e;return e=1<=arguments.length?g.call(arguments,0):[],this._batchTx=null,t=this.getIDBTransaction(e,"readwrite").then(function(t){return function(e){return t._batchTx=e}}(this)),{run:function(e){return function(n){return t.then(function(){try{return n(e)}finally{e._batchTx=null}})}}(this)}},t.prototype.doUpgrade=function(t,e){var r,o,i,u,s,c,f,h,l,p,d,m,y,b,g,w,D,I;if(null===this._dbDefinition)throw new n("DB definition not found.");for(r=new a(this._dbDefinition),i=[],u=t.objectStoreNames,s=function(o){var u,s,a,c,f,h,l,p,d,m;if(r.stores.hasOwnProperty(o)){for(d=e.objectStore(o),u=d.indexNames,m=r.stores[o],s=function(t){var e,r;if(!m.indexes.hasOwnProperty(t))return i.push(function(){return d.deleteIndex(t)});if(e=d.index(t),r=m.indexes[t],!e.unique&&r.option.unique)throw new n("Turning existed index("+t+") to be unique is not allowed.");return e.keyPath!==r.key||e.unique!==r.option.unique||e.multiEntry!==r.option.multiEntry?(i.push(function(){return d.deleteIndex(t)}),i.push(function(){return d.createIndex(t,r.key,r.option)})):void 0},f=0,h=u.length;h>f;f++)a=u[f],s(a);l=m.indexes,p=[];for(a in l)c=l[a],_.call(u,a)<0&&p.push(function(t,e,n){return i.push(function(){return t.createIndex(e,n.key,n.option)})}(d,a,c));return p}return i.push(function(){return t.deleteObjectStore(o)})},f=0,d=u.length;d>f;f++)D=u[f],s(D);y=r.stores;for(D in y)if(I=y[D],_.call(u,D)<0){w=t.createObjectStore(D,I.option),b=I.indexes,c=function(t,e,n){return i.push(function(){return t.createIndex(e,n.key,n.option)})};for(h in b)l=b[h],c(w,h,l)}for(g=[],p=0,m=i.length;m>p;p++)o=i[p],g.push(o());return g},t}(),e=function(){var e,r;return r={},e=function(e){return r.hasOwnProperty(e)||(r[e]=new t(e)),r[e]},e.Error=n,e}(),"function"==typeof define&&null!=define.amd?define("IDB",e):null!=("undefined"!=typeof module&&null!==module?module.exports:void 0)?module.exports=e:f.hasOwnProperty("IDB")?(d=f.IDB,f.IDB=e,f.IDB.noConflict=function(){return d}):f.IDB=e}).call(this);